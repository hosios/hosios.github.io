var search_col=[],target="shown",placeholder="",helpmsg="",displayall=!0,defsearchtype=0,cursearchtype=0,savesession=!1,sessionID="",sessionUUID="",defval="";const searchtypes=["+","&","&&"],searchtypesnames=["OR","AND","AND col"],defplaceholder="Search (? + Enter to get help)",defhelp="Help\nPerforms an OR search of the words listed (separated by spaces) in the various columns.\n\n• Start a search with '&' ⇒ all words must be present in the row\n• Start a search with '&&' ⇒ all words must be present in the same column\n• '!' before a word ⇒ the word must not be present\n• '=', '<' or '>' before a word (and after the '!' if present) ⇒ cell must be exactly equal to, begin with or end with the word. With the '=', replace spaces with '\\s', otherwise the word will be split\n'\"...\"' ⇒ considers everything between quotation marks as a word (including spaces)\n' before a word ⇒ the word need to be present independently ('ok' doesn't match 'books')\n• End a word with '@IdCol1,IdCol2' ⇒ the word must be present in the list of columns indicated (separated by commas). If a searched word contains '@', then add an '@' at the end to ignore it\n• Use '@IdCol1,IdCol2' as word ⇒ other words will only be searched in these columns\n• '/' before a word ⇒ use a regex. Use '\\s' for spaces, otherwise the regex will be split.\n";function saveOption(){try{target=document.getElementById("target").checked?document.getElementById("target").value:"shown",grist.widgetApi.setOption("target",target),displayall=document.getElementById("empty").checked,grist.widgetApi.setOption("displayall",displayall),defsearchtype=document.getElementById("defsearchtype").value,grist.widgetApi.setOption("defsearchtype",defsearchtype),cursearchtype=defsearchtype,defval=document.getElementById("defval").value,grist.widgetApi.setOption("defval",defval),savesession=document.getElementById("savesession").checked,grist.widgetApi.setOption("savesession",savesession),sessionID=document.getElementById("sessionID").value,grist.widgetApi.setOption("sessionID",sessionID),grist.widgetApi.setOption("sessionUUID",sessionUUID);let e=document.getElementById("columns").value.replace(/\s/g,"");search_col=0!==e.length?e.split(","):[],grist.widgetApi.setOption("search_col",search_col),placeholder=document.getElementById("placeholder").value,grist.widgetApi.setOption("placeholder",placeholder===defplaceholder?null:placeholder),document.getElementById("filter").placeholder=placeholder,helpmsg=document.getElementById("help").value,grist.widgetApi.setOption("helpmsg",helpmsg===defhelp?null:helpmsg),updateTag()}catch{}}function closeConfig(){document.getElementById("search").style.display="",document.getElementById("config").style.display="none"}function onLeave(){ApplyFilter()}function onKey(){if("Enter"===event.key)ApplyFilter();else{const e=event.target.value;e.startsWith("&&")?(cursearchtype=2,updateTag()):e.startsWith("&")?(cursearchtype=1,updateTag()):e.startsWith("+")?(cursearchtype=0,updateTag()):(cursearchtype=defsearchtype,updateTag())}}function tagclick(){cursearchtype=(cursearchtype+1)%searchtypes.length,updateTag();const e=document.getElementById("filter");e.value.startsWith("&&")?e.value=searchtypes[cursearchtype]+e.value.substring(2):e.value.startsWith("&")||e.value.startsWith("+")?e.value=searchtypes[cursearchtype]+e.value.substring(1):e.value=searchtypes[cursearchtype]+e.value}function updateTag(){document.getElementById("type").innerHTML=searchtypesnames[cursearchtype]}function clearsearch(){console.log("clear"),document.getElementById("filter").value="",cursearchtype=defsearchtype,updateTag(),ApplyFilter()}function ApplyFilter(){try{let e=document.getElementById("filter").value;if(savesession&&sessionStorage.setItem(sessionID.length>0?sessionID+"_Simple_Filter":sessionUUID,e),e&&0!==e.trim().length){if(e.startsWith("?"))return alert(helpmsg),void(document.getElementById("filter").value="");grist.fetchSelectedTable(format="columns",includeColumns=target).then((t=>{let r,n,l,a,o,i,d;if(d=search_col&&0!==search_col.length?search_col:Object.keys(t).filter((e=>"id"!==e)),[i,o]=parseinput(e),e.includes("@")){r=null;let e=[];for(c of o)c.startsWith("@")?r=[r,c.substring(1)].join(","):e.push(c);if(0===e.length)return void grist.setSelectedRows(displayall?null:[]);o=e,r&&(r=r.substring(1).split(","),r.length>0&&(d=r))}if("&&"===i){let e,r=t.id.filter(((r,i)=>{for(c of d){for(s of(e=!0,o))if([s,n,l,a,_]=parsesearch(s,d),l){if(matchtxt(t[c][i],s,n,a)){e=!1;break}}else if(!matchtxt(t[c][i],s,n,a)){e=!1;break}if(e)return!0}return!1}));grist.setSelectedRows(r)}else if("&"===i){let e=t.id.filter(((e,s)=>{let i=[];for(si in o){let e=o[si];if([e,n,l,a,r]=parsesearch(e,d),l){for(c of(i.push(!0),r))if(matchtxt(t[c][s],e,n,a)){i[si]=!1;break}}else for(c of(i.push(!1),r))if(matchtxt(t[c][s],e,n,a)){i[si]=!0;break}}return!i.includes(!1)}));grist.setSelectedRows(e)}else{let e=t.id.filter(((e,i)=>{for(s of o)if([s,n,l,a,r]=parsesearch(s,d),l){let e=!0;for(c of r)if(matchtxt(t[c][i],s,n,a)){e=!1;break}if(e)return!0}else for(c of r)if(matchtxt(t[c][i],s,n,a))return!0;return!1}));grist.setSelectedRows(e)}}))}else grist.setSelectedRows(displayall?null:[])}catch{grist.setSelectedRows([])}}function matchtxt(e,t,s,r){if(s)return s.test(e?.toString());switch(r){case"=":return e?.toString().toLowerCase()===t;case"<":return e?.toString().toLowerCase().startsWith(t);case">":return e?.toString().toLowerCase().endsWith(t);default:return e?.toString().toLowerCase().includes(t)}}function getregex(e){if(e.startsWith("/")){let t=e.split("/");const s=t.pop();return t.length>2?new RegExp(t.join("/").substring(1),s.length>0?s:"im"):new RegExp(s,"im")}return null}function gettype(e){let t=!1;switch(e.startsWith("!")&&(t=!0,e=e.substring(1)),e.substring(0,1)){case"=":return[e.substring(1),t,"="];case"<":return[e.substring(1),t,"<"];case">":return[e.substring(1),t,">"];case"'":return["/\\b"+e.substring(1).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")+"\\b",t,""];default:return[e,t,""]}}function parsesearch(e,t){let s=e.split("@");if(s.length>1){const e=s.pop();return s=gettype(s.join("@")),[s[0].toLowerCase(),getregex(s[0]),s[1],s[2],e.length>0?e.split(","):t]}return s=gettype(e),[s[0].toLowerCase(),getregex(s[0]),s[1],s[2],t]}function parsetype(e){return e.startsWith("&&")?["&&",2]:e.startsWith("&")?["&",1]:e.startsWith("+")?["+",0]:e.startsWith("@")?["@",1]:[searchtypes[defsearchtype],0]}function parseinput(e){let t,s,r=!1,n=[],l="";[t,s]=parsetype(e);for(let t=s;t<e.length;t++)" "!==e[t]||r?'"'===e[t]?r=!r:"\\"===e[t]?t<e.length&&'"'===e[t+1]&&(l+='"',t++):l+=e[t]:l.length>0&&(n.push(l),l="");return l.length>0&&n.push(l),[t,n]}function generateUUID(){var e=(new Date).getTime(),t="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(s){var r=16*Math.random();return e>0?(r=(e+r)%16|0,e=Math.floor(e/16)):(r=(t+r)%16|0,t=Math.floor(t/16)),("x"===s?r:3&r|8).toString(16)}))}grist.ready({requiredAccess:"read table",allowSelectBy:!0,onEditOptions(){document.getElementById("search").style.display="none",document.getElementById("config").style.display="",document.getElementById("target").checked="normal"===target,document.getElementById("empty").checked=!0===displayall,document.getElementById("defsearchtype").value=defsearchtype,document.getElementById("defval").value=defval,document.getElementById("savesession").checked=!0===savesession,document.getElementById("sessionID").value=sessionID,document.getElementById("columns").value=search_col.join(","),document.getElementById("placeholder").value=placeholder,document.getElementById("help").value=helpmsg}}),grist.onOptions(((e,t)=>{search_col=(e=e||{}).search_col||[],target=e.target||"shown",placeholder=e.placeholder||defplaceholder,helpmsg=e.helpmsg||defhelp,displayall=void 0===e.displayall||e.displayall,defsearchtype=e.defsearchtype||0,savesession=void 0!==e.savesession&&e.savesession,sessionID=e.sessionID||"",defval=e.defval||"",sessionUUID=e.sessionUUID||generateUUID(),closeConfig();const s=document.getElementById("filter");s.placeholder=placeholder,savesession&&(sessionID.length>0?s.value=sessionStorage.getItem(sessionID+"_Simple_Filter"):s.value=sessionStorage.getItem(sessionUUID)),0===s.value.length&&(s.value=defval),cursearchtype=searchtypes.indexOf(parsetype(s.value)[0]),console.log(cursearchtype),updateTag(),ApplyFilter()}));
